<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Dependencies -->
<dom-module id="bio-vis-hist">
    <template>
        <style>
        :host text {
            font: 12px sans-serif;
        }
        
        :host svg {
            display: block;
        }
        </style>
        <content>
            <div id="distHistogram" style="height:300px">
                <svg id="distHistogramSVG" style="height:300px">
                </svg>
            </div>
        </content>
    </template>
    <script>
    (function() {
        'use strict';

        Polymer({
            is: 'bio-vis-hist',

            properties: {
                featureData: {
                    type: Array,
                    value: [],
                    notify: true
                },
                values: {
                    type: Array,
                    computed: '_flatten(featureData)',
                    notify: true,
                    observer: '_render'
                }
            },
            ready: function() {
                //Visualisation
                var values = this._flatten(this.featureData);
                this._render(this.values);
            },
            _render: function(values) {

                var hist = d3.layout.histogram();
                hist.frequency(false); // Turn on probability

                var hist_values = hist(values);
                var data = {
                    key: '',
                    values: []
                };
                data["key"] = "Feature";
                // Convert to nvd3 json format
                for (var i = 0; i < hist_values.length; i++) {
                    data["values"].push({
                        x: (hist_values[i].x).toFixed(2),
                        y: hist_values[i].y
                    });
                }
                //console.log(data);

                var self = this;
                nv.addGraph({
                    generate: function() {
                        var chart = nv.models.multiBarChart()
                            .stacked(true);

                        // Custom tooltip 
                        // chart.tooltip.contentGenerator(function(key, y, e, graph) {
                        //   console.log(key)
                        //  return  '<p>' + '</p>'
                        // });

                        chart.yAxis
                            .axisLabel("Probability")
                            .axisLabelDistance(-5)
                            .tickFormat(d3.format(',.01f'));

                        chart.dispatch.on('renderEnd', function() {
                            console.log('Render Complete');
                        });
                        var svg = d3.select(self.$.distHistogramSVG)
                            .datum([data]);

                        console.log('calling chart');

                        svg.transition().duration(0).call(chart);
                        return chart;
                    },
                    callback: function(chart) {
                        nv.utils.windowResize(chart.update);
                    }
                });
            },
            _flatten: function(data) {
                var res = '';
                // Test if its an array
                if (Object.prototype.toString.call(data) === '[object Array]') {
                    res = data.map(function(d) {
                        return parseFloat(d[0]);
                    });
                }
                return res;
            }
        });
    })();
    </script>
</dom-module>
